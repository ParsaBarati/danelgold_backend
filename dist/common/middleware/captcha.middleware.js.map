{"version":3,"sources":["../../../src/common/middleware/captcha.middleware.ts"],"sourcesContent":["import {\n  BadRequestException,\n  Injectable,\n  InternalServerErrorException,\n  NestMiddleware,\n} from '@nestjs/common';\nimport axios from 'axios';\nimport { Request, Response, NextFunction } from 'express';\n\n@Injectable()\nexport class CaptchaMiddleware implements NestMiddleware {\n  async use(req: Request, res: Response, next: NextFunction) {\n    console.log('Request...');\n\n    const token = req.body['arcaptcha-token'];\n    console.log(`Received CAPTCHA token: ${token}`);\n\n    if (!token) {\n      throw new BadRequestException('خطای کپچا');\n    }\n\n    const verificationResult = await this.verifyCaptcha(token);\n\n    if (!verificationResult.success) {\n      throw new BadRequestException('خطای حل کپچا');\n    }\n\n    next();\n  }\n\n  private async verifyCaptcha(token: string) {\n    const secretKey = process.env.CAPTCHA_SECRET_KEY;\n    const siteKey = process.env.CAPTCHA_SITE_KEY;\n    const verifyUrl = 'https://api.arcaptcha.co/arcaptcha/api/verify';\n\n    const data = {\n      secret_key: secretKey,\n      challenge_id: token,\n      site_key: siteKey,\n    };\n\n    const response = await axios.post(verifyUrl, data);\n    const responseData = response.data;\n    console.log(`responseData >>>>>>> ${JSON.stringify(responseData)}`);\n\n    if (responseData.success) {\n      return { success: true, score: responseData.score };\n    } else {\n      return { success: false, score: responseData.score };\n    }\n  }\n}\n"],"names":["CaptchaMiddleware","use","req","res","next","console","log","token","body","BadRequestException","verificationResult","verifyCaptcha","success","secretKey","process","env","CAPTCHA_SECRET_KEY","siteKey","CAPTCHA_SITE_KEY","verifyUrl","data","secret_key","challenge_id","site_key","response","axios","post","responseData","JSON","stringify","score"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBALN;8DACW;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIX,IAAA,AAAMA,oBAAN,MAAMA;IACLC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB;;eAAzD,oBAAA;YACEC,QAAQC,GAAG,CAAC;YAEZ,MAAMC,QAAQL,IAAIM,IAAI,CAAC,kBAAkB;YACzCH,QAAQC,GAAG,CAAC,CAAC,wBAAwB,EAAEC,MAAM,CAAC;YAE9C,IAAI,CAACA,OAAO;gBACV,MAAM,IAAIE,2BAAmB,CAAC;YAChC;YAEA,MAAMC,qBAAqB,MAAM,MAAKC,aAAa,CAACJ;YAEpD,IAAI,CAACG,mBAAmBE,OAAO,EAAE;gBAC/B,MAAM,IAAIH,2BAAmB,CAAC;YAChC;YAEAL;QACF;;IAEcO,cAAcJ,KAAa;eAAzC,oBAAA;YACE,MAAMM,YAAYC,QAAQC,GAAG,CAACC,kBAAkB;YAChD,MAAMC,UAAUH,QAAQC,GAAG,CAACG,gBAAgB;YAC5C,MAAMC,YAAY;YAElB,MAAMC,OAAO;gBACXC,YAAYR;gBACZS,cAAcf;gBACdgB,UAAUN;YACZ;YAEA,MAAMO,WAAW,MAAMC,cAAK,CAACC,IAAI,CAACP,WAAWC;YAC7C,MAAMO,eAAeH,SAASJ,IAAI;YAClCf,QAAQC,GAAG,CAAC,CAAC,qBAAqB,EAAEsB,KAAKC,SAAS,CAACF,cAAc,CAAC;YAElE,IAAIA,aAAaf,OAAO,EAAE;gBACxB,OAAO;oBAAEA,SAAS;oBAAMkB,OAAOH,aAAaG,KAAK;gBAAC;YACpD,OAAO;gBACL,OAAO;oBAAElB,SAAS;oBAAOkB,OAAOH,aAAaG,KAAK;gBAAC;YACrD;QACF;;AACF"}