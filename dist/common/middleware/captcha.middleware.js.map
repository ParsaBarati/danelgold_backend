{"version":3,"sources":["../../../src/common/middleware/captcha.middleware.ts"],"sourcesContent":["import {\r\n  BadRequestException,\r\n  Injectable,\r\n  InternalServerErrorException,\r\n  NestMiddleware,\r\n} from '@nestjs/common';\r\nimport axios from 'axios';\r\nimport { Request, Response, NextFunction } from 'express';\r\n\r\n@Injectable()\r\nexport class CaptchaMiddleware implements NestMiddleware {\r\n  async use(req: Request, res: Response, next: NextFunction) {\r\n    console.log('Request...');\r\n\r\n    const token = req.body['arcaptcha-token'];\r\n    console.log(`Received CAPTCHA token: ${token}`);\r\n\r\n    if (!token) {\r\n      throw new BadRequestException('خطای کپچا');\r\n    }\r\n\r\n    const verificationResult = await this.verifyCaptcha(token);\r\n\r\n    if (!verificationResult.success) {\r\n      throw new BadRequestException('خطای حل کپچا');\r\n    }\r\n\r\n    next();\r\n  }\r\n\r\n  private async verifyCaptcha(token: string) {\r\n    const secretKey = process.env.CAPTCHA_SECRET_KEY;\r\n    const siteKey = process.env.CAPTCHA_SITE_KEY;\r\n    const verifyUrl = 'https://api.arcaptcha.co/arcaptcha/api/verify';\r\n\r\n    const data = {\r\n      secret_key: secretKey,\r\n      challenge_id: token,\r\n      site_key: siteKey,\r\n    };\r\n\r\n    const response = await axios.post(verifyUrl, data);\r\n    const responseData = response.data;\r\n    console.log(`responseData >>>>>>> ${JSON.stringify(responseData)}`);\r\n\r\n    if (responseData.success) {\r\n      return { success: true, score: responseData.score };\r\n    } else {\r\n      return { success: false, score: responseData.score };\r\n    }\r\n  }\r\n}\r\n"],"names":["CaptchaMiddleware","use","req","res","next","console","log","token","body","BadRequestException","verificationResult","verifyCaptcha","success","secretKey","process","env","CAPTCHA_SECRET_KEY","siteKey","CAPTCHA_SITE_KEY","verifyUrl","data","secret_key","challenge_id","site_key","response","axios","post","responseData","JSON","stringify","score"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBALN;8DACW;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIX,IAAA,AAAMA,oBAAN,MAAMA;IACLC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB;;eAAzD,oBAAA;YACEC,QAAQC,GAAG,CAAC;YAEZ,MAAMC,QAAQL,IAAIM,IAAI,CAAC,kBAAkB;YACzCH,QAAQC,GAAG,CAAC,CAAC,wBAAwB,EAAEC,MAAM,CAAC;YAE9C,IAAI,CAACA,OAAO;gBACV,MAAM,IAAIE,2BAAmB,CAAC;YAChC;YAEA,MAAMC,qBAAqB,MAAM,MAAKC,aAAa,CAACJ;YAEpD,IAAI,CAACG,mBAAmBE,OAAO,EAAE;gBAC/B,MAAM,IAAIH,2BAAmB,CAAC;YAChC;YAEAL;QACF;;IAEcO,cAAcJ,KAAa;eAAzC,oBAAA;YACE,MAAMM,YAAYC,QAAQC,GAAG,CAACC,kBAAkB;YAChD,MAAMC,UAAUH,QAAQC,GAAG,CAACG,gBAAgB;YAC5C,MAAMC,YAAY;YAElB,MAAMC,OAAO;gBACXC,YAAYR;gBACZS,cAAcf;gBACdgB,UAAUN;YACZ;YAEA,MAAMO,WAAW,MAAMC,cAAK,CAACC,IAAI,CAACP,WAAWC;YAC7C,MAAMO,eAAeH,SAASJ,IAAI;YAClCf,QAAQC,GAAG,CAAC,CAAC,qBAAqB,EAAEsB,KAAKC,SAAS,CAACF,cAAc,CAAC;YAElE,IAAIA,aAAaf,OAAO,EAAE;gBACxB,OAAO;oBAAEA,SAAS;oBAAMkB,OAAOH,aAAaG,KAAK;gBAAC;YACpD,OAAO;gBACL,OAAO;oBAAElB,SAAS;oBAAOkB,OAAOH,aAAaG,KAAK;gBAAC;YACrD;QACF;;AACF"}