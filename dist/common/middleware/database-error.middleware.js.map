{"version":3,"sources":["../../../src/common/middleware/database-error.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware, Logger } from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\nimport { Connection } from 'typeorm';\n\n@Injectable()\nexport class DatabaseErrorMiddleware implements NestMiddleware {\n  private logger = new Logger('DatabaseErrorMiddleware');\n\n  constructor(private readonly connection: Connection) {}\n\n  async use(req: Request, res: Response, next: NextFunction) {\n    try {\n      await this.checkDatabaseConnection();\n      await this.checkEntities();\n      next();\n    } catch (error) {\n      this.logger.error(`Database connection or entity error: ${error}`);\n      res.status(500).json({ message: 'Internal server error' });\n    }\n  }\n\n  private async checkDatabaseConnection() {\n    const isConnected = this.connection.isConnected;\n    if (!isConnected) {\n      await this.connection.connect();\n    }\n  }\n\n  private async checkEntities() {\n    const entityMetadatas = this.connection.entityMetadatas;\n    if (entityMetadatas.length === 0) {\n      throw new Error('No entities found in the database connection');\n    }\n    // Optional: Log entity names\n    entityMetadatas.forEach((metadata) => {\n      this.logger.log(`Found entity: ${metadata.name}`);\n    });\n  }\n}\n"],"names":["DatabaseErrorMiddleware","use","req","res","next","checkDatabaseConnection","checkEntities","error","logger","status","json","message","isConnected","connection","connect","entityMetadatas","length","Error","forEach","metadata","log","name","constructor","Logger"],"mappings":";;;;+BAKaA;;;eAAAA;;;wBALsC;yBAExB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGpB,IAAA,AAAMA,0BAAN,MAAMA;IAKLC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB;;eAAzD,oBAAA;YACE,IAAI;gBACF,MAAM,MAAKC,uBAAuB;gBAClC,MAAM,MAAKC,aAAa;gBACxBF;YACF,EAAE,OAAOG,OAAO;gBACd,MAAKC,MAAM,CAACD,KAAK,CAAC,CAAC,qCAAqC,EAAEA,MAAM,CAAC;gBACjEJ,IAAIM,MAAM,CAAC,KAAKC,IAAI,CAAC;oBAAEC,SAAS;gBAAwB;YAC1D;QACF;;IAEcN;;eAAd,oBAAA;YACE,MAAMO,cAAc,MAAKC,UAAU,CAACD,WAAW;YAC/C,IAAI,CAACA,aAAa;gBAChB,MAAM,MAAKC,UAAU,CAACC,OAAO;YAC/B;QACF;;IAEcR;;eAAd,oBAAA;YACE,MAAMS,kBAAkB,MAAKF,UAAU,CAACE,eAAe;YACvD,IAAIA,gBAAgBC,MAAM,KAAK,GAAG;gBAChC,MAAM,IAAIC,MAAM;YAClB;YACA,6BAA6B;YAC7BF,gBAAgBG,OAAO,CAAC,CAACC;gBACvB,MAAKX,MAAM,CAACY,GAAG,CAAC,CAAC,cAAc,EAAED,SAASE,IAAI,CAAC,CAAC;YAClD;QACF;;IA7BAC,YAAY,AAAiBT,UAAsB,CAAE;aAAxBA,aAAAA;aAFrBL,SAAS,IAAIe,cAAM,CAAC;IAE0B;AA8BxD"}