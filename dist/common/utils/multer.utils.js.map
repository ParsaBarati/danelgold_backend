{"version":3,"sources":["../../../src/common/utils/multer.utils.ts"],"sourcesContent":["import { ConfigService } from '@nestjs/config';\r\nimport { diskStorage } from 'multer';\r\nimport * as path from 'path';\r\nimport * as fs from 'fs-extra';\r\nimport { createSubdirectory } from './create-directory.utils';\r\nimport { BadRequestException } from '@nestjs/common';\r\n\r\nconst allowedExtensions = ['.jpg', '.jpeg', '.png', '.webp', 'm4v'];\r\n\r\nexport const multerConfigFactory = (configService: ConfigService) => ({\r\n  storage: diskStorage({\r\n    destination: async (req, file, cb) => {\r\n      try {\r\n        const subdirectory = createSubdirectory(new Date());\r\n        const directory = configService.get<string>('MULTER_DEST');\r\n        if (!directory) {\r\n          throw new Error('MULTER_DEST configuration is missing.');\r\n        }\r\n        const uploadDir = path.join(directory, subdirectory);\r\n        console.log(`uploadDir >>> ${uploadDir}`);\r\n        await fs.ensureDir(uploadDir);\r\n        cb(null, uploadDir);\r\n      } catch (error) {\r\n        cb(new Error(String(error)), '');\r\n      }\r\n    },\r\n    filename: async (req, file, cb) => {\r\n      try {\r\n        const extension = path.extname(file.originalname);\r\n        const baseName = path.basename(file.originalname, extension);\r\n        const directory = configService.get<string>('MULTER_DEST');\r\n        const subdirectory = createSubdirectory(new Date());\r\n        const uploadDir = path.resolve(directory, subdirectory);\r\n\r\n        let finalFilename = `${baseName}${extension}`;\r\n        let filePath = path.resolve(uploadDir, finalFilename);\r\n        let counter = 1;\r\n\r\n        while (await fs.pathExists(filePath)) {\r\n          finalFilename = `${baseName}-${counter}${extension}`;\r\n          filePath = path.resolve(uploadDir, finalFilename);\r\n          counter++;\r\n        }\r\n\r\n        cb(null, finalFilename);\r\n      } catch (error) {\r\n        cb(new Error(String(error)), '');\r\n      }\r\n    },\r\n  }),\r\n  fileFilter: (req, file, cb) => {\r\n    const ext = path.extname(file.originalname).toLowerCase();\r\n    if (allowedExtensions.includes(ext)) {\r\n      cb(null, true);\r\n    } else {\r\n      cb(\r\n        new BadRequestException(\r\n          'فرمت فایل مجاز نیست. فقط فایل‌های jpg, jpeg, png, و webp قابل قبول هستند.',\r\n        ),\r\n        false,\r\n      );\r\n    }\r\n  },\r\n});\r\n"],"names":["multerConfigFactory","allowedExtensions","configService","storage","diskStorage","destination","req","file","cb","subdirectory","createSubdirectory","Date","directory","get","Error","uploadDir","path","join","console","log","fs","ensureDir","error","String","filename","extension","extname","originalname","baseName","basename","resolve","finalFilename","filePath","counter","pathExists","fileFilter","ext","toLowerCase","includes","BadRequestException"],"mappings":";;;;+BASaA;;;eAAAA;;;wBARe;8DACN;iEACF;sCACe;wBACC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEpC,MAAMC,oBAAoB;IAAC;IAAQ;IAAS;IAAQ;IAAS;CAAM;AAE5D,MAAMD,sBAAsB,CAACE,gBAAkC,CAAA;QACpEC,SAASC,IAAAA,mBAAW,EAAC;YACnBC,WAAW;2BAAE,oBAAA,UAAOC,KAAKC,MAAMC;oBAC7B,IAAI;wBACF,MAAMC,eAAeC,IAAAA,wCAAkB,EAAC,IAAIC;wBAC5C,MAAMC,YAAYV,cAAcW,GAAG,CAAS;wBAC5C,IAAI,CAACD,WAAW;4BACd,MAAM,IAAIE,MAAM;wBAClB;wBACA,MAAMC,YAAYC,MAAKC,IAAI,CAACL,WAAWH;wBACvCS,QAAQC,GAAG,CAAC,CAAC,cAAc,EAAEJ,UAAU,CAAC;wBACxC,MAAMK,SAAGC,SAAS,CAACN;wBACnBP,GAAG,MAAMO;oBACX,EAAE,OAAOO,OAAO;wBACdd,GAAG,IAAIM,MAAMS,OAAOD,SAAS;oBAC/B;gBACF;gCAdoBhB,KAAKC,MAAMC;;;;YAe/BgB,QAAQ;2BAAE,oBAAA,UAAOlB,KAAKC,MAAMC;oBAC1B,IAAI;wBACF,MAAMiB,YAAYT,MAAKU,OAAO,CAACnB,KAAKoB,YAAY;wBAChD,MAAMC,WAAWZ,MAAKa,QAAQ,CAACtB,KAAKoB,YAAY,EAAEF;wBAClD,MAAMb,YAAYV,cAAcW,GAAG,CAAS;wBAC5C,MAAMJ,eAAeC,IAAAA,wCAAkB,EAAC,IAAIC;wBAC5C,MAAMI,YAAYC,MAAKc,OAAO,CAAClB,WAAWH;wBAE1C,IAAIsB,gBAAgB,CAAC,EAAEH,SAAS,EAAEH,UAAU,CAAC;wBAC7C,IAAIO,WAAWhB,MAAKc,OAAO,CAACf,WAAWgB;wBACvC,IAAIE,UAAU;wBAEd,MAAO,MAAMb,SAAGc,UAAU,CAACF,UAAW;4BACpCD,gBAAgB,CAAC,EAAEH,SAAS,CAAC,EAAEK,QAAQ,EAAER,UAAU,CAAC;4BACpDO,WAAWhB,MAAKc,OAAO,CAACf,WAAWgB;4BACnCE;wBACF;wBAEAzB,GAAG,MAAMuB;oBACX,EAAE,OAAOT,OAAO;wBACdd,GAAG,IAAIM,MAAMS,OAAOD,SAAS;oBAC/B;gBACF;gCAtBiBhB,KAAKC,MAAMC;;;;QAuB9B;QACA2B,YAAY,CAAC7B,KAAKC,MAAMC;YACtB,MAAM4B,MAAMpB,MAAKU,OAAO,CAACnB,KAAKoB,YAAY,EAAEU,WAAW;YACvD,IAAIpC,kBAAkBqC,QAAQ,CAACF,MAAM;gBACnC5B,GAAG,MAAM;YACX,OAAO;gBACLA,GACE,IAAI+B,2BAAmB,CACrB,8EAEF;YAEJ;QACF;IACF,CAAA"}