{"version":3,"sources":["../../../src/common/utils/swagger.utils.ts"],"sourcesContent":["import { Buffer } from 'buffer';\r\nimport { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';\r\nimport { config as dotenvConfig } from 'dotenv';\r\nimport { UnauthorizedException } from '@nestjs/common';\r\n\r\ndotenvConfig({ path: '.develop.env' });\r\n\r\nexport class SwaggerHelper {\r\n  private basePath = process.env.SWAGGER_PATH || 'api-docs';\r\n  private username = process.env.SWAGGER_USERNAME || 'admin';\r\n  private password = process.env.SWAGGER_PASSWORD || 'admin';\r\n  private title = process.env.SWAGGER_TITLE || 'API Documentation';\r\n  private description = process.env.SWAGGER_DESCRIPTION || 'API description';\r\n\r\n  setup(app) {\r\n    if (!this.basePath || !this.username || !this.password) {\r\n      console.error('Swagger Disabled : configuration missing ...');\r\n      return;\r\n    }\r\n\r\n    const config = new DocumentBuilder()\r\n      .setTitle(this.title)\r\n      .setDescription(this.description)\r\n      .setVersion('1.0.0')\r\n      .addBearerAuth()\r\n      .addGlobalParameters({\r\n        name: 'Accept-Language',\r\n        in: 'header',\r\n        schema: {\r\n          enum: ['en', 'fa'],\r\n        },\r\n      })\r\n      .build();\r\n\r\n    const expressApp = app.getHttpAdapter().getInstance();\r\n\r\n    expressApp.use((request, reply, next) =>\r\n      this.basicAuthInterceptor(request, reply, next),\r\n    );\r\n\r\n    const document = SwaggerModule.createDocument(app, config);\r\n    SwaggerModule.setup(this.basePath, app, document, {\r\n      swaggerOptions: {\r\n        persistAuthorization: true,\r\n        tagsSorter: 'alpha',\r\n        operationsSorter: 'alpha',\r\n      },\r\n      customJs: '/public/swagger-custom.js',\r\n    });\r\n  }\r\n\r\n  getBasePath() {\r\n    return this.basePath.startsWith('/') ? this.basePath : `/${this.basePath}`;\r\n  }\r\n\r\n  setError(reply: any, next: any) {\r\n    console.log('Authorization Failed. Check username and password.');\r\n    reply.header('WWW-Authenticate', 'Basic realm=\"Paraf\" charset=\"UTF-8\"');\r\n    next(new UnauthorizedException());\r\n  }\r\n\r\n  basicAuthInterceptor(request: any, reply: any, next: any) {\r\n    const url = request.url.split('?').shift().replace(/\\/+$/, '');\r\n    if (url !== this.getBasePath() && url !== `${this.getBasePath()}-json`) {\r\n      next();\r\n      return;\r\n    }\r\n    let credentials = request.headers['authorization'];\r\n    if (typeof credentials !== 'string') {\r\n      this.setError(reply, next);\r\n      return;\r\n    }\r\n    credentials = credentials.replace('Basic ', '');\r\n    const credentialsDecoded = Buffer.from(credentials, 'base64').toString(\r\n      'utf-8',\r\n    );\r\n    const userPassRE = /^([^:]*):(.*)$/;\r\n    const userPass = userPassRE.exec(credentialsDecoded);\r\n    if (userPass[1] === this.username && userPass[2] === this.password) {\r\n      console.log('Authorization Successful.');\r\n      next();\r\n      return;\r\n    }\r\n    this.setError(reply, next);\r\n  }\r\n}\r\n"],"names":["SwaggerHelper","dotenvConfig","path","setup","app","basePath","username","password","console","error","config","DocumentBuilder","setTitle","title","setDescription","description","setVersion","addBearerAuth","addGlobalParameters","name","in","schema","enum","build","expressApp","getHttpAdapter","getInstance","use","request","reply","next","basicAuthInterceptor","document","SwaggerModule","createDocument","swaggerOptions","persistAuthorization","tagsSorter","operationsSorter","customJs","getBasePath","startsWith","setError","log","header","UnauthorizedException","url","split","shift","replace","credentials","headers","credentialsDecoded","Buffer","from","toString","userPassRE","userPass","exec","process","env","SWAGGER_PATH","SWAGGER_USERNAME","SWAGGER_PASSWORD","SWAGGER_TITLE","SWAGGER_DESCRIPTION"],"mappings":";;;;+BAOaA;;;eAAAA;;;wBAPU;yBACwB;wBACR;wBACD;AAEtCC,IAAAA,cAAY,EAAC;IAAEC,MAAM;AAAe;AAE7B,IAAA,AAAMF,gBAAN,MAAMA;IAOXG,MAAMC,GAAG,EAAE;QACT,IAAI,CAAC,IAAI,CAACC,QAAQ,IAAI,CAAC,IAAI,CAACC,QAAQ,IAAI,CAAC,IAAI,CAACC,QAAQ,EAAE;YACtDC,QAAQC,KAAK,CAAC;YACd;QACF;QAEA,MAAMC,SAAS,IAAIC,wBAAe,GAC/BC,QAAQ,CAAC,IAAI,CAACC,KAAK,EACnBC,cAAc,CAAC,IAAI,CAACC,WAAW,EAC/BC,UAAU,CAAC,SACXC,aAAa,GACbC,mBAAmB,CAAC;YACnBC,MAAM;YACNC,IAAI;YACJC,QAAQ;gBACNC,MAAM;oBAAC;oBAAM;iBAAK;YACpB;QACF,GACCC,KAAK;QAER,MAAMC,aAAapB,IAAIqB,cAAc,GAAGC,WAAW;QAEnDF,WAAWG,GAAG,CAAC,CAACC,SAASC,OAAOC,OAC9B,IAAI,CAACC,oBAAoB,CAACH,SAASC,OAAOC;QAG5C,MAAME,WAAWC,sBAAa,CAACC,cAAc,CAAC9B,KAAKM;QACnDuB,sBAAa,CAAC9B,KAAK,CAAC,IAAI,CAACE,QAAQ,EAAED,KAAK4B,UAAU;YAChDG,gBAAgB;gBACdC,sBAAsB;gBACtBC,YAAY;gBACZC,kBAAkB;YACpB;YACAC,UAAU;QACZ;IACF;IAEAC,cAAc;QACZ,OAAO,IAAI,CAACnC,QAAQ,CAACoC,UAAU,CAAC,OAAO,IAAI,CAACpC,QAAQ,GAAG,CAAC,CAAC,EAAE,IAAI,CAACA,QAAQ,CAAC,CAAC;IAC5E;IAEAqC,SAASb,KAAU,EAAEC,IAAS,EAAE;QAC9BtB,QAAQmC,GAAG,CAAC;QACZd,MAAMe,MAAM,CAAC,oBAAoB;QACjCd,KAAK,IAAIe,6BAAqB;IAChC;IAEAd,qBAAqBH,OAAY,EAAEC,KAAU,EAAEC,IAAS,EAAE;QACxD,MAAMgB,MAAMlB,QAAQkB,GAAG,CAACC,KAAK,CAAC,KAAKC,KAAK,GAAGC,OAAO,CAAC,QAAQ;QAC3D,IAAIH,QAAQ,IAAI,CAACN,WAAW,MAAMM,QAAQ,CAAC,EAAE,IAAI,CAACN,WAAW,GAAG,KAAK,CAAC,EAAE;YACtEV;YACA;QACF;QACA,IAAIoB,cAActB,QAAQuB,OAAO,CAAC,gBAAgB;QAClD,IAAI,OAAOD,gBAAgB,UAAU;YACnC,IAAI,CAACR,QAAQ,CAACb,OAAOC;YACrB;QACF;QACAoB,cAAcA,YAAYD,OAAO,CAAC,UAAU;QAC5C,MAAMG,qBAAqBC,cAAM,CAACC,IAAI,CAACJ,aAAa,UAAUK,QAAQ,CACpE;QAEF,MAAMC,aAAa;QACnB,MAAMC,WAAWD,WAAWE,IAAI,CAACN;QACjC,IAAIK,QAAQ,CAAC,EAAE,KAAK,IAAI,CAACnD,QAAQ,IAAImD,QAAQ,CAAC,EAAE,KAAK,IAAI,CAAClD,QAAQ,EAAE;YAClEC,QAAQmC,GAAG,CAAC;YACZb;YACA;QACF;QACA,IAAI,CAACY,QAAQ,CAACb,OAAOC;IACvB;;aA5EQzB,WAAWsD,QAAQC,GAAG,CAACC,YAAY,IAAI;aACvCvD,WAAWqD,QAAQC,GAAG,CAACE,gBAAgB,IAAI;aAC3CvD,WAAWoD,QAAQC,GAAG,CAACG,gBAAgB,IAAI;aAC3ClD,QAAQ8C,QAAQC,GAAG,CAACI,aAAa,IAAI;aACrCjD,cAAc4C,QAAQC,GAAG,CAACK,mBAAmB,IAAI;;AAyE3D"}