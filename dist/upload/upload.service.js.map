{"version":3,"sources":["../../src/upload/upload.service.ts"],"sourcesContent":["import {PaginationResult, PaginationService} from '@/common/paginate/pagitnate.service';\r\nimport {Injectable, NotFoundException} from '@nestjs/common';\r\nimport {InjectRepository} from '@nestjs/typeorm';\r\nimport {Upload} from './entity/uplaod.entity';\r\nimport {Repository} from 'typeorm';\r\nimport {join} from 'path';\r\n\r\nimport fs from 'fs-extra';\r\nimport {ApiResponses, createResponse} from '@/utils/response.util';\r\n\r\nimport {User} from '@/User/user/entity/user.entity';\r\nimport { Post } from '@/Social/Post/posts/entity/posts.entity';\r\n\r\n@Injectable()\r\nexport class UploadService {\r\n    constructor(\r\n        @InjectRepository(Upload)\r\n        private readonly uploadRepository: Repository<Upload>,\r\n        @InjectRepository(Post)\r\n        private readonly postRepository: Repository<Post>,\r\n        @InjectRepository(User)\r\n        private readonly userRepository: Repository<User>,\r\n        private readonly paginationService: PaginationService,\r\n    ) {\r\n    }\r\n\r\n    async createUploads(files: Express.Multer.File[]): Promise<{ uploads: Upload[]; links: string[] }> {\r\n        if (!files || !files || files.length === 0) {\r\n            throw new NotFoundException('No files to upload');\r\n        }\r\n\r\n        const uploads = [];\r\n        const links = [];\r\n        const baseUrl = process.env.BASE_URL_UPLOAD;\r\n\r\n        const timestamp = Date.now();\r\n        for (const file of files) {\r\n            const sizeFile = file.size;\r\n            const uploadFileName = file.filename;\r\n            const uploadDestination = file.destination;\r\n            const uploadMemType = file.mimetype;\r\n\r\n            const newUpload = this.uploadRepository.create({\r\n                name: uploadFileName,\r\n                size: sizeFile,\r\n                memType: file.mimetype,\r\n                destination: file.destination,\r\n            });\r\n\r\n            const savedUpload = await this.uploadRepository.save(newUpload);\r\n            const encodedFileName = `${savedUpload.destination.replace(/\\\\/g, '/')}/${encodeURIComponent(savedUpload.name)}`;\r\n            const link = baseUrl + encodedFileName;\r\n\r\n            uploads.push(savedUpload);\r\n            links.push(link);\r\n        }\r\n\r\n        return {uploads, links};\r\n    }\r\n\r\n    async createUpload(file: any): Promise<{ upload: Upload; link: string }> {\r\n        if (!file) {\r\n            throw new NotFoundException('No file to upload');\r\n        }\r\n\r\n        const sizeFile = file.size;\r\n        const uploadFileName = file.filename;\r\n        const uploadDestination = file.destination;\r\n        const uploadMemType = file.mimetype;\r\n\r\n        const newUpload = this.uploadRepository.create({\r\n            name: uploadFileName,\r\n            size: sizeFile,\r\n            memType: uploadMemType,\r\n            destination: uploadDestination,\r\n        });\r\n\r\n        const savedUpload = await this.uploadRepository.save(newUpload);\r\n\r\n        // Generate the file link\r\n        const baseUrl = process.env.BASE_URL_UPLOAD;\r\n        const encodedFileName = `${savedUpload.destination.replace(/\\\\/g, '/')}/${encodeURIComponent(savedUpload.name)}`;\r\n        const link = baseUrl + encodedFileName;\r\n\r\n        // Return an object with the Upload entity and the generated link\r\n        return {upload: savedUpload, link};\r\n    }\r\n\r\n    async uploadReel(file: Express.Multer.File, caption: string, user: User): Promise<Post> {\r\n        const { link } = await this.createUpload(file);\r\n        \r\n        const reel = this.postRepository.create({\r\n            mediaUrl: link,\r\n            caption,\r\n            isReel: true,\r\n            user,\r\n        });\r\n        \r\n        return this.postRepository.save(reel);\r\n    }\r\n\r\n    async getAllUploads(\r\n        query: any,\r\n    ): Promise<ApiResponses<PaginationResult<Upload>>> {\r\n        const {page, limit, search, sort, sortOrder} = query;\r\n\r\n        const queryBuilder = this.uploadRepository.createQueryBuilder('upload');\r\n\r\n        if (search) {\r\n            queryBuilder.andWhere('upload.name ILIKE :search', {\r\n                search: `%${search}%`,\r\n            });\r\n        }\r\n\r\n        if (sort) {\r\n            queryBuilder.orderBy(`upload.${sort}`, sortOrder as 'ASC' | 'DESC');\r\n        } else {\r\n            queryBuilder.orderBy('upload.id', 'DESC');\r\n        }\r\n\r\n        const paginationResult = await this.paginationService.paginate<Upload>(\r\n            queryBuilder,\r\n            page,\r\n            limit,\r\n        );\r\n\r\n        const baseUrl = process.env.BASE_URL_UPLOAD;\r\n\r\n        const uploadsWithLinks = paginationResult.data.map((upload) => ({\r\n            ...upload,\r\n            link:\r\n                baseUrl +\r\n                `${upload.destination.replace(/\\\\/g, '/')}` +\r\n                `/${encodeURIComponent(upload.name).replace(/%5C/g, '/')}`,\r\n        }));\r\n\r\n        const resultWithLinks = {\r\n            ...paginationResult,\r\n            data: uploadsWithLinks,\r\n        };\r\n\r\n        return createResponse(200, resultWithLinks);\r\n    }\r\n\r\n    async deleteUpload(id: number): Promise<ApiResponses<{ message: string }>> {\r\n        const upload = await this.uploadRepository.findOne({where: {id}});\r\n\r\n        if (!upload) {\r\n            throw new NotFoundException('فایل یافت نشد');\r\n        }\r\n\r\n        const filePath = join(upload.destination, upload.name);\r\n\r\n        await this.uploadRepository.remove(upload);\r\n\r\n        fs.unlink(filePath, (err) => {\r\n            if (err) {\r\n                console.error('Error deleting file:', err);\r\n            } else {\r\n                console.log('File deleted successfully:', filePath);\r\n            }\r\n        });\r\n\r\n        return createResponse(200, {message: 'فایل با موفقیت حذف شد'});\r\n    }\r\n\r\n    async deleteMultipleUploads(\r\n        ids: number[],\r\n    ): Promise<ApiResponses<{ message: string }>> {\r\n        const uploads = await this.uploadRepository.findByIds(ids);\r\n\r\n        if (uploads.length === 0) {\r\n            throw new NotFoundException('هیچ فایلی یافت نشد');\r\n        }\r\n\r\n        for (const upload of uploads) {\r\n            const filePath = join(upload.destination, upload.name);\r\n\r\n            await this.uploadRepository.remove(upload);\r\n\r\n            fs.unlink(filePath, (err) => {\r\n                if (err) {\r\n                    console.error('Error deleting file:', err);\r\n                } else {\r\n                    console.log('File deleted successfully:', filePath);\r\n                }\r\n            });\r\n        }\r\n\r\n        return createResponse(200, {message: 'فایل‌ها با موفقیت حذف شدند'});\r\n    }\r\n\r\n    async getUploadById(id: number): Promise<any> {\r\n        const upload = await this.uploadRepository.findOne({\r\n            where: {id},\r\n        });\r\n\r\n        if (!upload) {\r\n            throw new NotFoundException('فایلی پیدا نشد');\r\n        }\r\n\r\n        const name = upload.name;\r\n        const destination = upload.destination;\r\n        console.log(`destination ${destination}`);\r\n        const filePath = join(destination, name).replace(/\\\\/g, '/');\r\n\r\n        console.log(`filePath ${filePath}`);\r\n\r\n        const baseUrl = process.env.BASE_URL_UPLOAD;\r\n        const encodedFileName =\r\n            `${destination.replace(/\\\\/g, '/')}` + `/${encodeURIComponent(name)}`;\r\n        const uploadWithLink = {\r\n            ...upload,\r\n            link: `${baseUrl}${encodedFileName}`,\r\n        };\r\n\r\n        return createResponse(200, uploadWithLink);\r\n    }\r\n\r\n    async getUploadByPath(name: string): Promise<any> {\r\n        const upload = await this.uploadRepository.findOne({\r\n            where: {name},\r\n        });\r\n\r\n        if (!upload) {\r\n            throw new NotFoundException('فایلی پیدا نشد');\r\n        }\r\n\r\n        const uploadName = upload.name;\r\n        const destination = upload.destination;\r\n        console.log(`destination ${destination}`);\r\n        const filePath = join(destination, uploadName).replace(/\\\\/g, '/');\r\n\r\n        console.log(`filePath ${filePath}`);\r\n\r\n        return createResponse(200, filePath);\r\n    }\r\n\r\n    async createProfilePictureUpload(\r\n        file: any,\r\n        user: User,\r\n    ): Promise<ApiResponses<any>> {\r\n        if (!file) {\r\n            throw new NotFoundException('File not found');\r\n        }\r\n\r\n\r\n        if (!user) {\r\n            throw new NotFoundException('User not found');\r\n        }\r\n\r\n        const newUpload = this.uploadRepository.create({\r\n            name: file.filename,\r\n            size: file.size,\r\n            memType: file.mimetype,\r\n            destination: file.destination,\r\n        });\r\n\r\n        const savedUpload = await this.uploadRepository.save(newUpload);\r\n\r\n        user.profilePic =\r\n            `${process.env.BASE_URL_UPLOAD}` +\r\n            `${savedUpload.destination.replace(/\\\\/g, '/')}` +\r\n            `/${encodeURIComponent(savedUpload.name)}`;\r\n        await this.userRepository.save(user);\r\n\r\n        const uploadWithLink = {\r\n            ...savedUpload,\r\n            link: user.profilePic,\r\n            profilePic: user.profilePic,\r\n        };\r\n\r\n        return createResponse(\r\n            200,\r\n            uploadWithLink,\r\n            'Profile picture uploaded successfully!',\r\n        );\r\n    }\r\n}\r\n"],"names":["UploadService","createUploads","files","length","NotFoundException","uploads","links","baseUrl","process","env","BASE_URL_UPLOAD","timestamp","Date","now","file","sizeFile","size","uploadFileName","filename","uploadDestination","destination","uploadMemType","mimetype","newUpload","uploadRepository","create","name","memType","savedUpload","save","encodedFileName","replace","encodeURIComponent","link","push","createUpload","upload","uploadReel","caption","user","reel","postRepository","mediaUrl","isReel","getAllUploads","query","page","limit","search","sort","sortOrder","queryBuilder","createQueryBuilder","andWhere","orderBy","paginationResult","paginationService","paginate","uploadsWithLinks","data","map","resultWithLinks","createResponse","deleteUpload","id","findOne","where","filePath","join","remove","fs","unlink","err","console","error","log","message","deleteMultipleUploads","ids","findByIds","getUploadById","uploadWithLink","getUploadByPath","uploadName","createProfilePictureUpload","profilePic","userRepository","constructor"],"mappings":"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"}